---
title: "Informe PVS"
author: "UIAPB"
date: "18/12/2017"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
runtime: shiny
---


```{r message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
library(readr)
library(dplyr)
library(lubridate)
library(tidyr)
library(flexdashboard)

base<-read_delim("/home/art/shiny-server/PVS/pruevashiny.csv", ";", escape_double = FALSE, locale = locale(date_names = "es", date_format = " %d/%m/%Y"), trim_ws = TRUE)
#base<-read_delim("/media/Datos/Data_science/Mis proyectos/shiny-server/PVS/pruevashiny.csv", ";", escape_double = FALSE, locale = locale(date_names = "es", date_format = " %d/%m/%Y"), trim_ws = TRUE)

base<-base[!is.na(base$Sexo),]
base$grupo <-ifelse(base$grupo=="Control","Control", "Intervención")

nm <- (as.Date("2016-05-01")%--%max(base$Fecha_Cita__yyyymmdd_))%/%months(1)

fechas <- as.Date("2016-05-01") + 0:nm * months(1)

source("/home/art/shiny-server/funciones.R")

```

# Introduction {.sidebar}
El informe PVS bla bla bla fdsfdasfdasfasd        sdfasdfdsafasdf
sdfsdfsdafasd     
y esto y lo otro


# Curva de progreso

## Row 1

### 
```{r echo=FALSE}

  inputPanel("Filtrar:",
  radioButtons("Sexo", "Sexo:", choices = list("Todos" = 1, "Hombres" = 2, "Mujeres" = 3), 
                   selected = 1),
  
  sliderInput("Edad", label = "Edad:",
              min = 10, max = 80, value = c(10,80)))
     
 inputPanel("Estratificar:",
 radioButtons("Estra", "Estratos:", choices = list("Ninguno" = 1, "Sexo" = 2, "Edad" = 3), 
                   selected = 1))
```
  
  
### Analizar  
```{r, echo = FALSE}
  inputPanel( h3("Analizar:"),
    checkboxGroupInput("Habitos", label = h4("Hábitos"), 
     choices = list("A1 (al menos un hábito)" = "A1", "A1 Actividad física" = "A1_AF", "A1 Dieta" = "A1_DT", 
                    "A1 Tabaco" = "A1_TB")))       
```

## Gráfico
```{r, echo = FALSE}
renderPlot({
  
  bas<-filter(base, edad_consult>input$Edad[1], edad_consult<(input$Edad[2]+1))
  
  if (input$Sexo == 2)  bas <- bas %>% filter(Sexo == "Hombre")
  if (input$Sexo == 3)  bas <- bas %>% filter(Sexo == "Mujer")
  
  if (input$Estra == 1) bas <- bas %>% curva_pro(fechas) %>% gather(habito, porcen, -fechas)
  if (input$Estra == 2) bas <- bas %>% split(bas$Sexo) %>% lapply(curva_pro, fechas) %>% bind_rows(.id="Sexo") %>%  
    gather(habito,porcen, -c(fechas, Sexo))
  if (input$Estra == 3) bas <- bas %>% split(bas$edad) %>% lapply(curva_pro, fechas) %>% bind_rows(.id="Edad") %>% gather(habito, porcen, -c(fechas, Edad))
  
  bas <- bas %>%  filter(habito %in% input$Habitos)
  
  p <- ggplot(bas, aes(x=fechas, y = porcen, col = habito)) + geom_line()
  if (input$Estra == 2) p <- p + facet_wrap(~Sexo)
  if (input$Estra == 3) p <- p + facet_wrap(~Edad)
  
  print(p)
  
})

```

















